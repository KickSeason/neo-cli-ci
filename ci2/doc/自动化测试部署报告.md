# neo-cli自动化测试流程报告
## 1.背景
neo现在有了自动化测试框架，但是目前只能人工部署环境，并触发测试，既浪费时间又需要单独的云服务器来运行测试。所以需要一套自动化的测试流程和更少的额外设备。
## 2.现状
1. neo-cli源代码托管于github
2. travis可以免费为github开源项目免费提供虚拟机，执行CI和测试等工作
3. traivs可以提供各种语言的支持环境，shell脚本，可以使用docker服务，并且可以对敏感数据加密，可以通过ssh操作远程主机
## 3. 部署流程
1. 首先要编写Dockerfile构建用于启动测试容器的镜像
* neo-cli运行需要dotnet环境，测试框架需要python3环境，可以直接以kickseason/dotnetandpython为基础进行构建
* 测试需要启动两个容器，一个用来启动共识节点，另一个启动普通节点并运行测试用例，根据职责不同需要两个不同的镜像，参阅：
[consensus-container](https://github.com/KickSeason/neo-cli-ci/blob/master/ci2/consensus-container/Dockerfile)
[ordinary-container](https://github.com/KickSeason/neo-cli-ci/blob/master/ci2/ordinary-container/Dockerfile)
2. github集成traivs测试需要在neo-cli仓库中编写.traivs.yml文件，
```

sudo: required

services:
  - docker

script:
- docker build -f ci2/consensus-container/Dockerfile -t consensus .
- docker build -f ci2/ordinary-container/Dockerfile -t ordinary .
- docker network create --driver bridge --subnet=172.18.12.0/16 --gateway=172.18.1.1 neonet
- docker run -d --name cns --network=neonet --ip 172.18.12.1 consensus
- docker run --name ord --network=neonet --ip 172.18.12.2 ordinary
```
因为我们的工作都在docker中完成，所以travis的工作只是用来启动我们的两个容器。  
3. 在travis页面的account的repositories中将github项目设置为active, 然后启动build即可。
## 4.自动化测试流程
1. github/neo-project/neo-cli的master分支在有新的提交后，可以触发travis的build，build过程在neo-cli中的.travis.yml文件来定义
2. docker中运行neo-cli和测试框架需要dotnet和python3环境, 这个我已经构建名为kickseason/dotnetandpython的镜像并上传到dockerhub作为基础镜像
3. 首先使用consensus/Dockerfile构建运行四个共识节点和测试框架的docker镜像
4. 然后使用ordinay/Dockerfile构建运行一个普通节点和测试框架的docker镜像
5. 创建一个docker network目的是让运行共识节点的容器有固定ip地址，这样neo-cli不需要修改protocol.json文件
6. 使用固定的ip172.18.12.1地址启动共识节点容器
7. 使用固定ip172.18.12.2启动普通节点容器
8. 普通节点容器中执行测试框架的自检程序，并能够连接共识节点，确认环境部署成功
9. 从普通节点容器将编译好的neo-cli还有每个节点的配置文件发送到指定节点，并启动共识节点和所有普通节点。
10. 在普通节点容器中对普通节点执行测试，运行所有测试用例，包括neo-cli命令测试和rpc测试
11. 测试过程以log形式可以在travis网站上查看
12. 查看测试结果后，对失败的用例，测试人员进行确认是否存在bug
> 测试框架目前存在问题，需要持续完善
## 5.测试流程图
![test proecss](https://github.com/KickSeason/neo-cli-ci/blob/master/ci2/doc/auto-test-process.png)
